import"https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js";import{getApp,getApps,initializeApp}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import{getFirestore,addDoc,collection,doc,updateDoc,Timestamp}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-lite.js";import"https://unpkg.com/axios/dist/axios.min.js";const inputElement=document.querySelector("input"),submitButton=document.querySelector("#submit"),responseElement=document.querySelector("#response"),errorElement=document.querySelector("#error"),loaderElement=document.querySelector("#loader");function displayText(e,t){loaderElement.style.display="none","response"==e?(errorElement.style.display="none",errorElement.textContent="",responseElement.textContent="",responseElement.style.display="block",t=t.replace(/&/g,"&amp;"),new Typed(responseElement,{strings:[t],contentType:"html",typeSpeed:10,showCursor:!1,onComplete:()=>{toggleInput("allow"),inputFocus()}})):"error"==e&&(responseElement.style.display="none",responseElement.textContent="",errorElement.textContent=t,errorElement.style.display="block",toggleInput("allow"),inputFocus())}function displayLoader(){responseElement.style.display="none",errorElement.style.display="none",loaderElement.style.display="block"}function clearInput(){inputElement.value=""}function changePlaceholder(e){inputElement.placeholder=e}function closeKeyboard(){inputElement.blur()}function inputFocus(){inputElement.setAttribute("readonly","readonly"),inputElement.focus(),inputElement.removeAttribute("readonly")}function inputPlaceholderAndFocus(){new Typed(inputElement,{strings:["^1000 Ask me anything about Gui..."],contentType:"null",attr:"placeholder",typeSpeed:30,showCursor:!1,onComplete:()=>{inputFocus()}})}function toggleInput(e){"forbid"==e?inputElement.disabled=!0:"allow"==e&&(inputElement.disabled=!1)}function sanitizeInput(e){return e=(e=(e=e.replace(/<[^>]+>/g,"")).replace(/[\s\t\r\n]+/g," ")).trim()}function validateInput(e){return e&&" "!=e?e.length>200?{assessment:"Too long",message:"⚠️ Oops! Your message is too long, please make it shorter."}:/^[A-Za-zÀ-ÖØ-öø-ÿ0-9\s.,!?;:'’"()-]+$/.test(e)?{assessment:"OK",message:""}:{assessment:"Forbidden characters",message:"⚠️ Oops! Please use only letters, numbers, and common punctuation."}:{assessment:"Empty",message:""}}const firebaseConfig={apiKey:"AIzaSyDOa3qhxiNI_asmIo1In1UF_qNjO1qllBE",authDomain:"guiruggiero.firebaseapp.com",projectId:"guiruggiero",storageBucket:"guiruggiero.appspot.com",messagingSenderId:"49247152565",appId:"1:49247152565:web:eb614bed7a4cf43ed611fc"},firebaseApp=getApps().length?getApp():initializeApp(firebaseConfig),db=getFirestore(firebaseApp),firestoreMode="mvp";async function createLog(e,t){return(await addDoc(collection(db,"mvp"),{origin:"GuiPT",start:e,turnCount:1,turns:t})).id}async function logTurn(e,t,n,o){const s=doc(db,"mvp",e);await updateDoc(s,{turnCount:t,duration:o,turns:n})}const cloudFunctionURL="https://us-central1-guiruggiero.cloudfunctions.net/guipt";let timeoutFunction,turnHistory,chatStart,chatID,chatHistory=[],turnCount=0;async function GuiPT(){try{0==turnCount&&(chatStart=Timestamp.now().toDate());const e=inputElement.value,t=sanitizeInput(e),n=validateInput(t);if("Empty"==n.assessment&&"block"==responseElement.style.display)return;if("OK"!=n.assessment)return"Too long"==n.assessment&&clearInput(),void displayText("error",n.message);closeKeyboard(),changePlaceholder(" "+e),clearInput(),toggleInput("forbid"),displayLoader();timeoutFunction=setTimeout((()=>{displayText("error","⚠️ ZzZzZ... This is taking too long, can you please try again?")}),31e3),await axios.post(cloudFunctionURL,null,{params:{history:chatHistory,prompt:t}}).then((async e=>{clearTimeout(timeoutFunction);const n=e.data;displayText("response",n),turnCount++,chatHistory.push({role:"user",parts:[{text:t}]}),chatHistory.push({role:"model",parts:[{text:n}]});const o={user:t,model:n};if(1==turnCount)turnHistory={[turnCount]:o},chatID=await createLog(chatStart,turnHistory);else{turnHistory={...turnHistory,[turnCount]:o};let e=(Timestamp.now().toDate()-chatStart)/6e4;e=Number(e.toFixed(2)),await logTurn(chatID,turnCount,turnHistory,e)}}))}catch(e){clearTimeout(timeoutFunction),console.error(e),displayText("error","⚠️ Oops! Something went wrong, can you please try again?")}}document.addEventListener("DOMContentLoaded",(()=>{submitButton.addEventListener("click",(()=>{GuiPT()})),inputElement.addEventListener("keyup",(e=>{"Enter"===e.key&&GuiPT()}))})),inputPlaceholderAndFocus();